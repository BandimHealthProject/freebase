<!doctype html>
<html>
	<head>
		<!--
		<script src='app/system/js/mock/odkDataIf.js'></script>
		-->
		<!--<script src='js/devenv.js'></script>-->
		<script type="text/javascript" data-main="../app/system/survey/js/main" src="../app/system/libs/require.2.3.3.js"></script>
		<script src='../app/system/js/odkData.js'></script>
		<script src='../app/system/js/odkCommon.js'></script>
		<script src='../app/config/assets/formgen_common.js'></script>
		<script src='../app/config/assets/generate_common.js'></script>
		<script>
			var columns = {};
			var metadata = null;
			var fail = function failure() {
				alert(Array.prototype.slice.call(arguments, 0).join(", "))
			}
			var ol = function ol() {
				for (var i = 0; i < all_tables.length; i++) {
					var option = document.createElement("option")
					option.value = all_tables[i];
					option.innerText = display(localized_tables[all_tables[i]], all_tables[i], window.possible_wrapped.concat("title"), all_tables[i]);
					document.getElementById("table_id").appendChild(option)
				}
				document.getElementById("table_id").selectedIndex = 0;
				document.getElementById("iframe").style.height = document.body.scrollHeight.toString() + "px"
				var block = function block() {
					if (typeof(odkData) == "undefined" || typeof(odkDataIf) == "undefined") {
						setTimeout(block, 100);
						return;
					}
					document.getElementById("iframe"). src='../app/config/assets/table_slave.html'
					newTable();
				}
				setTimeout(block, 0);
			}
			var deleting = false;
			var display_col = "";
			var sample_data = ["sample data", "sample data 2", "1234", "example of some really long example data", "1901-02-03T04:05:06.7891011"]
			var getColumns = function getColumns(other_table, callback) {
				if (typeof(columns[other_table]) != "undefined") {
					callback();
					return;
				}
				odkData.arbitraryQuery(other_table, "SELECT * FROM " + other_table, [], 0, 0, function(d) {
					columns[other_table] = []
					metadata = d.getMetadata();
					for (var i = 0; i < d.getColumns().length; i++) {
						if (d.getColumns()[i][0] == "_") {
							continue;
						}
						columns[other_table] = columns[other_table].concat(d.getColumns()[i])
					}
					callback();
				}, fail);
			}
			var resetDatabase = function resetDatabase() {
				//deleting = true;
				//odkData.arbitraryQuery(table_id, "DELETE FROM " + table_id, [], 10000, 0, function(d) {
					//deleting = false;
				//}, fail);
				var count = -1;
				odkData.arbitraryQuery(table_id, "SELECT * FROM " + table_id, [], 10000, 0, function(d) {
					//count = d.getCount();
					count = d.resultObj.data.length
				})
				getColumns(table_id, function() {
					//getDisplayCol();
					redrawDisplayCol(false);
					//var running = sample_data.length;
					var running = 0;
					//var all_to_set = [display_col]
					//for (var i = 0; i < display_subcol.length; i++) all_to_set = all_to_set.concat(display_subcol[i][1])
					var all_to_set = []
					var do_inserts = function() {
						//for (var i = 0; i < sample_data.length; i++) {
						for (var i = 0; i < 5 - count; i++) {
							var defaults = {};
							for (var j = 0; j < all_to_set.length; j++) {
								//defaults[all_to_set[j]] = sample_data[i]
								defaults[all_to_set[j]] = all_to_set[j]
							}
							running++;
							odkData.addRow(table_id, defaults, newGuid(), function(d) {
								running--;
							}, fail)
						}
					}
					// wait until we know the number of rows to insert to start doing inserts
					var block = function() {
						//if (deleting) {
						if (count == -1) {
							setTimeout(block, 100);
							return;
						}
						do_inserts()
						block2();
					}
					// wait until the inserts are done to call update
					var block2 = function() {
						if (running > 0) {
							setTimeout(block2, 100);
							return;
						}
						update();
					}
					block();
				})
			}
			var table_id = null;
			var newTable = function newTable() {
				table_id = document.getElementById("table_id").selectedOptions[0].value;
				document.getElementById("subcols").innerHTML = ""
				resetDatabase();
			}
			var getDisplayCol = function getDisplayCol() {
				display_col = document.getElementById("display_col").selectedOptions[0]
				if (typeof(display_col) == "undefined") display_col = {"value": ""}
				display_col = display_col.value
			}
			var update = function update() {
				getDisplayCol();
				getDisplaySubcols();
				getGroupBys();
				getJoins();
				getColsToSelect();
				var iframe = document.getElementById("iframe")
				iframe.contentWindow.odkDataIf = odkDataIf
				iframe.contentWindow.odkData = odkData
				iframe.contentWindow.location.hash = "#" + table_id
				iframe.contentWindow.table_id = table_id
				try {
					iframe.contentWindow.ol();
				} catch (e) {
					// this is expected
				}
				iframe.contentWindow.display_col = display_col
				iframe.contentWindow.display_subcol = display_subcol
				iframe.contentWindow.allowed_group_bys = allowed_group_bys
				iframe.contentWindow.update_total_rows(true);
				var pre = document.getElementById("exported")
				pre.innerHTML = ""
				pre.appendChild(document.createTextNode(
					"table_id = " + print(table_id) + ";"
				));
				pre.appendChild(document.createElement("br"))
				pre.appendChild(document.createTextNode(
					"display_col = " + print(display_col) + ";"
				))
				pre.appendChild(document.createElement("br"))
				pre.appendChild(document.createTextNode(
					"display_subcol = " + print(display_subcol) + ";"
				));
				if (allowed_group_bys != null) {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"allowed_group_bys = " + print(allowed_group_bys) + ";"
					));
				}
				if (global_join.length > 0) {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"global_join = " + print(global_join) + ";"
					));
				}
				if (global_cols_to_select != "*" && global_cols_to_select != table_id + ".*") {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"global_cols_to_select = " + print(global_cols_to_select) + ";"
					));
				}
			}
			var global_join = "";
			var display_subcol = []
			var getDisplaySubcols = function getDisplaySubcols() {
				display_subcol = []
				var count = document.getElementById("subcols").children.length;
				for (var i = 0; i < count; i++) {
					var elem = document.getElementById("subcols-" + i);
					var text = elem.getElementsByTagName("input")[0].value
					var opt = elem.getElementsByTagName("select")[0].selectedOptions[0] 
					var col = opt == null ? "" : opt.value
					col = col == "_null" ? null : col
					var nl = elem.getElementsByTagName("select")[1].selectedOptions[0].value.toString().toLowerCase() == "false" ? false : true
					var triplet = [text, col, nl];
					display_subcol = display_subcol.concat(0)
					display_subcol[i] = triplet;
				}
			}
			var redrawDisplaySubcols = function redrawDisplaySubcols(first) {
				var expected_count = display_subcol.length;
				var children = document.getElementById("subcols").children;
				var count = children == null ? 0 : children.length;
				for (var i = 0; i < expected_count - count; i++) {
					add(true);
				}
				count = expected_count;
				if (!first) getColsToSelect()
				for (var i = 0; i < count; i++) {
					var div = document.getElementById("subcols-" + i);
					div.getElementsByTagName("input")[0].value = display_subcol[i][0];
					var select = div.getElementsByTagName("select")[0]
					select.innerHTML = "";
					var cols = ["_null"].concat(columns[table_id]);
					for (var j = 0; j < all_cols_to_select.length; j++) {
						cols = cols.concat(all_cols_to_select[j][1])
					}
					for (var j = 0; j < cols.length; j++) {
						var col = cols[j];
						var option = document.createElement("option")
						option.value = col;
						option.innerText = displayCol(col, metadata, table_id, table_id);
						select.appendChild(option)
						if (col == display_subcol[i][1]) {
							select.selectedIndex = j;
						}
					}
					div.getElementsByTagName("select")[1].selectedIndex = display_subcol[i][2] ? 0 : 1;
				}
			}
			var load = function load() {
				getColumns(table_id, function() {
					if (all_joins != []) goAdvanced();
					if (all_cols_to_select != []) goAdvanced();
					if (allowed_group_bys != null) goAdvanced();
					redrawDisplayCol(true);
					redrawDisplaySubcols(true);
					redrawGroupBys(true);
					redrawJoins(true, function() {
						// DON'T CALL UPDATE UNTIL THIS IS DONE
						redrawColsToSelect(true, update);
					});
				});
			}
			var save = function save() {
				update()
				var pre = document.getElementById("exported")
				var part = pre.innerText;
				part += "\n"
				part += "all_cols_to_select = " + print(all_cols_to_select) + ";"
				part += "\n"
				part += "all_joins = " + print(all_joins) + ";"
				return part
			}
			var add = function add(first) {
				var div = document.createElement("div")
				var idx = document.getElementById("subcols").children.length;
				div.id = "subcols-" + idx;
				var text = document.createElement("input")
				text.type = "text";
				text.setAttribute("data-subcol", idx);
				text.addEventListener("change", update);
				text.placeholder = "Text to display before the selected column, if any."
				var select = document.createElement("select")
				select.addEventListener("change", update)
				select.setAttribute("data-subcol", idx);
				var select2 = document.createElement("select")
				select2.addEventListener("change", update)
				select2.setAttribute("data-subcol", idx);
				var option = document.createElement("option")
				option.value = true;
				option.innerText = "true";
				select2.appendChild(option)
				option = document.createElement("option")
				option.value = false;
				option.innerText = "false";
				select2.appendChild(option)
				var remove = document.createElement("button")
				remove.innerText = "-"
				remove.addEventListener("click", function() {
					alert("TODO");
				});
				div.appendChild(text);
				div.appendChild(select);
				div.appendChild(select2);
				div.appendChild(remove);
				document.getElementById("subcols").appendChild(div)
				display_subcol = display_subcol.concat(0);
				display_subcol[display_subcol.length - 1] = ["", "", true]
				if (!first) redrawDisplaySubcols(false);
			}
			var goAdvanced = function() {
				if (advanced) return;
				document.getElementById("goAdvanced").outerHTML = ""
				var allow_group_bys = document.createElement("input")
				allow_group_bys.type = "checkbox"
				allow_group_bys.id = "allow_group_bys"
				allow_group_bys.checked = true;
				allow_group_bys.addEventListener("change", update)
				document.getElementById("right").appendChild(allow_group_bys)
				document.getElementById("right").appendChild(document.createTextNode("Allow group bys"))
				var group_bys = document.createElement("div")
				group_bys.id = "group_bys"
				document.getElementById("right").appendChild(group_bys)
				redrawGroupBys(true);
				var addjoin = document.createElement("button")
				addjoin.innerText = "Add join"
				addjoin.addEventListener("click", function() { newjoin(false); })
				var joins = document.createElement("div")
				joins.id = "joins"
				document.getElementById("right").appendChild(addjoin)
				document.getElementById("right").appendChild(joins)
				//redrawJoins(true);
				var cols_to_select = document.createElement("div");
				cols_to_select.id = "cols_to_select"
				document.getElementById("right").appendChild(cols_to_select);
				redrawColsToSelect(true);
				advanced = true;
			}
			var all_cols_to_select = []
			var newjoin = function newjoin(first) {
				var handler = function() {
					redrawColsToSelect(false);
					update();
				}
				var joins = document.getElementById("joins")
				var idx = document.getElementById("joins").children.length
				var wrapper = document.createElement("div");
				wrapper.id = "join-" + idx;
				wrapper.innerText = "JOIN "
				var select1 = document.createElement("select")
				select1.addEventListener("change", function() { redrawJoin(idx, false); handler(); });
				wrapper.appendChild(select1)
				wrapper.appendChild(document.createTextNode(" ON " + table_id))
				wrapper.appendChild(document.createTextNode("."))
				var select2 = document.createElement("select")
				select2.addEventListener("change", handler);
				wrapper.appendChild(select2);
				wrapper.appendChild(document.createTextNode(" = "))
				var span = document.createElement("span")
				span.id = "join-" + idx + "-span"
				wrapper.appendChild(span)
				wrapper.appendChild(document.createTextNode("."))
				var select3 = document.createElement("select")
				select3.addEventListener("change", handler);
				wrapper.appendChild(select3);
				var btn = document.createElement("button")
				btn.innerText = "-"
				btn.addEventListener("click", function() {
					alert("TODO")
				});
				wrapper.appendChild(btn);
				joins.appendChild(wrapper)
				if (!first) {
					all_joins = all_joins.concat(0);
					all_joins[idx] = [table_id, columns[table_id][0], columns[table_id][0]];
				}
				redrawJoin(idx, first);
			}
			var redrawJoin = function redrawJoin(idx, first, cb) {
				if (!first) getJoins();
				var thing = document.getElementById("join-" + idx)
				var select1 = thing.getElementsByTagName("select")[0]
				select1.innerHTML = "";
				for (var i = 0; i < all_tables.length; i++) {
					var option = document.createElement("option")
					option.value = all_tables[i];
					option.innerText = display(localized_tables[all_tables[i]], all_tables[i], window.possible_wrapped.concat("title"), all_tables[i]);
					select1.appendChild(option);
					if (all_joins[idx][0] == all_tables[i]) {
						select1.selectedIndex = i;
					}
				}
				if (!first) getJoins();
				var select2 = thing.getElementsByTagName("select")[1];
				select2.innerHTML = ""
				for (var i = 0; i < columns[table_id].length; i++) {
					var col = columns[table_id][i];
					var option = document.createElement("option")
					option.value = col;
					option.innerText = displayCol(col, metadata, table_id);
					select2.appendChild(option);
					if (all_joins[idx][1] == col) {
						select2.selectedIndex = i;
					}
				}

				var tbl = all_joins[idx][0];
				document.getElementById("join-" + idx + "-span").innerText = display(localized_tables[tbl], tbl, window.possible_wrapped.concat("title"), tbl);
				getColumns(tbl, function() {
					var select = thing.getElementsByTagName("select")[2];
					select.innerHTML = "";
					var cols = ["_id"].concat(columns[tbl])
					for (var i = 0; i < cols.length; i++) {
						var col = cols[i];
						var option = document.createElement("option")
						option.value = col;
						option.innerText = displayCol(col, metadata, tbl);
						select.appendChild(option);
						if (all_joins[idx][2] == col) {
							select.selectedIndex = i;
						}
					}
					if (typeof(cb) != "undefined") cb()
				});
			}
			var getJoins = function getJoins() {
				if (!advanced) {
					all_joins = []
					return;
				}
				all_joins = []
				var thing = document.getElementById("joins")
				for (var i = 0; i < thing.children.length; i++) {
					var join = document.getElementById("join-" + i);
					all_joins = all_joins.concat(0);
					var selects = join.getElementsByTagName("select");
					all_joins[i] = [
						selects[0].selectedOptions[0] == null ? table_id : selects[0].selectedOptions[0].value,
						selects[1].selectedOptions[0] == null ? "" : selects[1].selectedOptions[0].value,
						selects[2].selectedOptions[0] == null ? "" : selects[2].selectedOptions[0].value
					]
				}
				global_join = []
				for (var i = 0; i < all_joins.length; i++) {
					global_join = global_join.concat(all_joins[i][0] + " ON " + table_id + "." + all_joins[i][1] + " = " + all_joins[i][0] + "." + all_joins[i][2])
				}
				global_join = global_join.join(" JOIN ")
			}
			var redrawJoins = function redrawJoins(first, cb) {
				if (!first) getJoins();
				var len = document.getElementById("joins").children.length;
				for (var i = 0; i < all_joins.length - len; i++) {
					newjoin(first);
					len++;
				}
				var running = len;
				for (var i = 0; i < len; i++) {
					redrawJoin(i, first, function() { running--; });
				}
				var post = function post() {
					if (running > 0) {
						setTimeout(post, 50);
						return;
					}
					cb();
				}
				if (typeof(cb) != "undefined") post();
			}
			var all_joins = []
			var advanced = false;
			var getGroupBys = function getGroupBys() {
				if (!advanced) return;
				if (!document.getElementById("allow_group_bys").checked) {
					allowed_group_bys = [];
					return allow_group_bys;
				}
				allowed_group_bys = []
				var elems = document.getElementsByClassName("group_by")
				for (var i = 0; i < elems.length; i++) {
					var elem = elems[i];
					if (elem.checked) {
						var col = elem.getAttribute("data-dbcol")
						var display_input = document.getElementById(col + "-display")
						if (display_input.tagName == "SELECT") {
							var value = display_input.selectedOptions[0].value
							if (value == "custom") {
								display_input.outerHTML = "<input type='text' id='"+col+"-display' />"
								document.getElementById(col + "-display").value = displayCol(col, metadata, table_id, table_id)
								document.getElementById(col + "-display").addEventListener("change", update)
								display_input = true;
							} else {
								display_input = value == "true" ? true : false;
							}
						} else {
							display_input = display_input.value;
						}
						allowed_group_bys = allowed_group_bys.concat(0);
						allowed_group_bys[allowed_group_bys.length - 1] = [col, display_input]
					}
				}
			}
			var redrawGroupBys = function redrawGroupBys(first) {
				if (!first) getColsToSelect();
				var group_bys = document.getElementById("group_bys");
				group_bys.innerHTML = ""
				var cols = columns[table_id]
				for (var j = 0; j < all_cols_to_select.length; j++) {
					cols = cols.concat(all_cols_to_select[j][1])
				}
				for (var i = 0; i < cols.length; i++) {
					var col = cols[i];
					var box = document.createElement("input")
					box.type = "checkbox"
					box.setAttribute("data-dbcol", col);
					box.classList.add("group_by")
					box.id = col;
					box.name = col;
					box.addEventListener("change", update)
					var exists = false;
					var value = true
					if (allowed_group_bys == null) {
						exists = true;
					} else {
						for (var j = 0; j < allowed_group_bys.length; j++) {
							if (allowed_group_bys[j][0] == col) {
								exists = true;
								value = allowed_group_bys[j][1];
								break;
							}
						}
					}
					if (exists) {
						box.checked = true;
					}
					var select;
					if (value === true || value === false) {
						select = document.createElement("select");
						var option = document.createElement("option")
						option.value = "true";
						option.innerText = "Pretty"
						select.appendChild(option)
						option = document.createElement("option")
						option.value = "false";
						option.innerText = "Raw"
						select.appendChild(option)
						option = document.createElement("option")
						option.value = "custom";
						option.innerText = "Custom"
						select.appendChild(option)
						select.selectedIndex = value == true ? 0 : 1;
					} else {
						select = document.createElement("input")
						select.type = "text"
						select.value = value;
					}
					select.id = col + "-display"
					select.addEventListener("change", update);
					var label = document.createElement("label")
					label.setAttribute("for", col);
					label.innerText = displayCol(col, metadata, table_id, table_id);
					var wrapper = document.createElement("div")
					wrapper.appendChild(box)
					wrapper.appendChild(select)
					wrapper.appendChild(label)
					group_bys.appendChild(wrapper)
				}
			}
			var getColsToSelect = function getColsToSelect() {
				if (!advanced) {
					global_cols_to_select = table_id + ".*"
					all_cols_to_select = [];
					return;
				}
				var elems = document.getElementById("cols_to_select").getElementsByTagName("input")
				all_cols_to_select = [];
				for (var i = 0; i < elems.length; i += 2) {
					if (!elems[i].checked) continue;
					all_cols_to_select = all_cols_to_select.concat(0);
					all_cols_to_select[all_cols_to_select.length - 1] = [elems[i].getAttribute("data-dbcol"), elems[i + 1].value]
				}
				global_cols_to_select = table_id + ".*"
				for (var i = 0; i < all_cols_to_select.length; i++) {
					global_cols_to_select += ", " + all_cols_to_select[i][0] + " AS " + all_cols_to_select[i][1]
				}
			}
			var global_cols_to_select = "*";
			var redrawColsToSelect = function redrawColsToSelect(first, cb) {
				if (!first) getColsToSelect()
				var handler = function handler() {
					// TODO redraw display col too
					redrawDisplaySubcols(first);
					redrawGroupBys(first);
					update();
				}
				var div = document.getElementById("cols_to_select")
				div.innerHtml = ""
				div.innerText = table_id + ".*, "
				if (!first) getJoins()
				var running = all_joins.length;
				for (var i = 0; i < all_joins.length; i++) {
					var tbl = all_joins[i][0];
					//running++; // BAD IDEA TEMP
					getColumns(tbl, function() {
						for (var j = 0; j < columns[tbl].length; j++) {
							var col = columns[tbl][j];
							var wrapper = document.createElement("div")
							var box = document.createElement("input")
							box.addEventListener("change", handler);
							box.type = "checkbox"
							box.id = "select-" + tbl + "-" + col;
							box.setAttribute("data-dbcol", tbl + "." + col)
							var found = false;
							var value = ""
							for (var k = 0; k < all_cols_to_select.length; k++) {
								//alert("Checking that " + all_cols_to_select[k][0] + " matches " + tbl + "." + col);
								if (all_cols_to_select[k][0] == tbl + "." + col) {
									found = true;
									value = all_cols_to_select[k][1];
									break;
								}
							}
							box.checked = found;
							wrapper.appendChild(box)
							wrapper.appendChild(document.createTextNode(tbl + "." + displayCol(col, metadata, tbl, tbl) + " AS "))
							var input = document.createElement("input")
							input.addEventListener("change", handler);
							input.id = "select-" + tbl + "-" + col + "-as";
							input.value = value;
							wrapper.appendChild(input);
							div.appendChild(wrapper);
						}
						running--;
					})
				}
				if (typeof(cb) != "undefined") {
					var post = function post() {
						if (running > 0) {
							setTimeout(post, 50);
							return;
						}
						cb();
					}
					post();
				}
			}
			var redrawDisplayCol = function redrawDisplayCol(first) {
				if (!first) getDisplayCol();
				console.log("DISPLAY COL IS " + display_col)
				var cols = columns[table_id];
				for (var i = 0; i < all_cols_to_select.length; i++) {
					cols = cols.concat(all_cols_to_select[i][1]);
				}
				document.getElementById("display_col").innerHTML = ""
				for (var i = 0; i < cols.length; i++) {
					var option = document.createElement("option")
					option.value = cols[i];
					option.innerText = displayCol(cols[i], metadata, table_id, table_id);
					document.getElementById("display_col").appendChild(option)
					console.log("Checking " + cols[i] + " against " + display_col)
					if (cols[i] == display_col) {
						document.getElementById("display_col").selectedIndex = i;
					}
				}
			}
			var allowed_group_bys = null;
			var global_joins = []
			var print = function print(thing) {
				//return JSON.stringify(thing, null, "\t")
				return JSON.stringify(thing)
			}
			var userSave = function() {
				prompt("Copy this configuration to somewhere safe.", save())
			}
			var userLoad = function() {
				("global",eval)(prompt("Paste in your saved configuration here"))
				load();
			}
		</script>
		<style>
			#iframe {
				width: 70%;
				top: 0%;
				bottom: 0%;
				display: block;
				position: absolute;
				left: 0%;
				background-color: white;
			}
			#right {
				position: absolute;
				left: 71%;
				width: 29%;
				top: 8px;
			}
			body {
				min-height: 100%;
			}
			select {
				min-width: 100px;
			}
			label {
				padding-left: 8px;
			}
		</style>
	</head>
	<body onLoad='ol();'>
		<iframe id='iframe'></iframe>
		<div id='right'>
			<button onClick='userSave();' id='save'>Save</button><br />
			<button onClick='userLoad();' id='load'>Load</button><br />
			<button onClick='goAdvanced();' id='goAdvanced'>Go Advanced</button><br />
			Table: 
			<select id='table_id' onChange='newTable();'></select>
			<br />
			Display Column: 
			<select id='display_col' onChange='update();'></select>
			<br />
			<button id='add' onClick='add(false);'>+</button>
			<div id='subcols'></div>
			<pre style="display: none" id='exported'></pre>
		</div>
	</body>
</html>
