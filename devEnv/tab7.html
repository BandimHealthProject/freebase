<!doctype html>
<html>
	<head>
		<!--
		<script src='app/system/js/mock/odkDataIf.js'></script>
		-->
		<!--<script src='js/devenv.js'></script>-->
		<script type="text/javascript" data-main="../app/system/survey/js/main" src="../app/system/libs/require.2.3.3.js"></script>
		<script src='../app/system/js/odkData.js'></script>
		<script src='../app/system/js/odkCommon.js'></script>
		<script src='../app/config/assets/formgen_common.js'></script>
		<script src='../app/config/assets/generate_common.js'></script>
		<script src='constants.js'></script>
		<script>
			// Holds the id of the table we're currently editing
			var table_id = null;
			// A map from table_id to a list of the user defined columns in that table
			var columns = {};
			// Cached metadata object used for localizing column names
			var metadata = null;
			// For documentation on these options, see the readme for formgen
			var display_col = "";
			var display_subcol = []
			var allowed_group_bys = null;
			var global_which_cols_to_select = "*";
			var global_join = "";
			// we store global_which_cols_to_select as a string so we can give it to the slave iframe, but we can't parse that string so for when the
			// user is saving/loading configuration, we store/read it out of this.
			// the format is [["table_a", "column_key_in_table_a", "alias"], ...]
			// one triplet for each extra column to select
			var all_cols_to_select = []
			// again, we can't parse the global_join string, so store it like this
			// format is [[ /* JOIN */ "table_a", /* ON table_id.*/ "column_in_main_table", /* = table_a.*/ "relevant_column_in_table_a"], ...]
			var all_joins = [];
			// holds whether the user has clicked the advanced button or not
			var advanced = false;
			// failure function used in all the odkData calls
			var fail = function failure() {
				alert(Array.prototype.slice.call(arguments, 0).join(", "))
			}
			// Run on page load, ensures we have an odkData and odkDataIf then updates the panel on the right
			var ol = function ol() {
				for (var i = 0; i < all_tables.length; i++) {
					var option = document.createElement("option")
					option.value = all_tables[i];
					option.innerText = display(localized_tables[all_tables[i]], all_tables[i], window.possible_wrapped.concat("title"), all_tables[i]);
					document.getElementById("table_id").appendChild(option)
				}
				document.getElementById("table_id").selectedIndex = 0;
				document.getElementById("iframe").style.height = document.body.scrollHeight.toString() + "px"
				var block = function block() {
					if (typeof(odkData) == "undefined" || typeof(odkDataIf) == "undefined") {
						setTimeout(block, 100);
						return;
					}
					document.getElementById("iframe"). src='../app/config/assets/table_slave.html'
					newTable();
				}
				setTimeout(block, 0);
			}
			// Will get the columns for the requested table, put them in the global columns mapping then call your callback function
			var getColumns = function getColumns(other_table, callback) {
				if (typeof(columns[other_table]) != "undefined") {
					callback();
					return;
				}
				odkData.arbitraryQuery(other_table, "SELECT * FROM " + other_table, [], 0, 0, function(d) {
					columns[other_table] = []
					// store off metadata for translation in the callback
					metadata = d.getMetadata();
					for (var i = 0; i < d.getColumns().length; i++) {
						if (d.getColumns()[i][0] == "_") {
							continue;
						}
						columns[other_table] = columns[other_table].concat(d.getColumns()[i])
					}
					callback();
				}, fail);
			}
			// Ensures that we have at least 5 fake rows in the database
			var resetDatabase = function resetDatabase() {
				var count = -1;
				// First, get the number of rows
				odkData.arbitraryQuery(table_id, "SELECT * FROM " + table_id, [], 10000, 0, function(d) {
					count = d.resultObj.data.length
				})
				// Simultaniously, get the columns in the table
				getColumns(table_id, function() {
					// 
					redrawDisplayCol(false);
					var running = 0;
					var all_to_set = []
					var do_inserts = function() {
						for (var i = 0; i < 5 - count; i++) {
							var defaults = {};
							for (var j = 0; j < all_to_set.length; j++) {
								defaults[all_to_set[j]] = all_to_set[j]
							}
							running++;
							odkData.addRow(table_id, defaults, newGuid(), function(d) {
								running--;
							}, fail)
						}
					}
					// wait until we know the number of rows to insert to start doing inserts
					var block = function() {
						if (count == -1) {
							setTimeout(block, 100);
							return;
						}
						do_inserts()
						block2();
					}
					// wait until the inserts are done to call update
					var block2 = function() {
						if (running > 0) {
							setTimeout(block2, 100);
							return;
						}
						update();
					}
					block();
				})
			}
			// Removes all the display subcolumns and changes the global table_id variable, called when the user selects
			// a new table in the list
			var newTable = function newTable() {
				table_id = document.getElementById("table_id").selectedOptions[0].value;
				document.getElementById("subcols").innerHTML = ""
				resetDatabase();
			}
			// Pulls the data off the screen for the main display column
			var getDisplayCol = function getDisplayCol() {
				display_col = document.getElementById("display_col").selectedOptions[0]
				if (typeof(display_col) == "undefined") display_col = {"value": ""}
				display_col = display_col.value
			}
			// First, update all our global variables with the data on the screen, then give those variables to our iframe, and put the configuration in pre, even though pre is hidden right now
			var update = function update() {
				getDisplayCol();
				getDisplaySubcols();
				getGroupBys();
				getJoins();
				getColsToSelect();
				var iframe = document.getElementById("iframe")
				iframe.contentWindow.odkDataIf = odkDataIf
				iframe.contentWindow.odkData = odkData
				iframe.contentWindow.location.hash = "#" + table_id
				iframe.contentWindow.table_id = table_id
				iframe.contentDocument.getElementById("table_id").innerText = display(localized_tables[table_id], table_id, window.possible_wrapped.concat("title"), table_id)
				iframe.contentWindow.display_col = display_col
				iframe.contentWindow.display_subcol = display_subcol
				iframe.contentWindow.allowed_group_bys = allowed_group_bys
				iframe.contentWindow.update_total_rows(true);
				// Everything down here is just adding the javascript to the screen so the user can copy/paste it out
				var pre = document.getElementById("exported")
				pre.innerHTML = ""
				pre.appendChild(document.createTextNode(
					"table_id = " + print(table_id) + ";"
				));
				pre.appendChild(document.createElement("br"))
				pre.appendChild(document.createTextNode(
					"display_col = " + print(display_col) + ";"
				))
				pre.appendChild(document.createElement("br"))
				pre.appendChild(document.createTextNode(
					"display_subcol = " + print(display_subcol) + ";"
				));
				if (allowed_group_bys != null) {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"allowed_group_bys = " + print(allowed_group_bys) + ";"
					));
				}
				if (global_join.length > 0) {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"global_join = " + print(global_join) + ";"
					));
				}
				if (global_which_cols_to_select != "*" && global_which_cols_to_select != table_id + ".*") {
					pre.appendChild(document.createElement("br"))
					pre.appendChild(document.createTextNode(
						"global_which_cols_to_select = " + print(global_which_cols_to_select) + ";"
					));
				}
			}
			// Finds all the display subcol elements on the screen, takes their value and puts it in the global display_subcol variable
			var getDisplaySubcols = function getDisplaySubcols() {
				display_subcol = []
				var count = document.getElementById("subcols").children.length;
				for (var i = 0; i < count; i++) {
					var elem = document.getElementById("subcols-" + i);
					var text = elem.getElementsByTagName("input")[0].value
					var opt = elem.getElementsByTagName("select")[0].selectedOptions[0] 
					var col = opt == null ? "" : opt.value
					col = col == "empty" ? null : col
					var nl = elem.getElementsByTagName("select")[1].selectedOptions[0].value.toString().toLowerCase() == "false" ? false : true
					var triplet = {"display_name": text, "newline": nl}
					if (col != null) {
						triplet["column"] = col;
					}
					display_subcol = display_subcol.concat(triplet)
				}
			}
			// Called when we load configuration, will update the elements on the page to match the global display_subcols variable (if first is true, otherwise it will pull the data off the screen first)
			var redrawDisplaySubcols = function redrawDisplaySubcols(first) {
				var expected_count = display_subcol.length;
				var children = document.getElementById("subcols").children;
				var count = children == null ? 0 : children.length;
				// add enough display subcol elements to represent the display_subcol variable
				for (var i = 0; i < expected_count - count; i++) {
					add(true);
				}
				count = expected_count;
				if (!first) getColsToSelect()
				for (var i = 0; i < count; i++) {
					var div = document.getElementById("subcols-" + i);
					// set the before-text
					div.getElementsByTagName("input")[0].value = display_subcol[i]["display_name"];
					var select = div.getElementsByTagName("select")[0]
					// repopulate the options in the dropdown, one for each column with an "empty" option at the beginning
					select.innerHTML = "";
					var cols = ["empty"].concat(columns[table_id]);
					for (var j = 0; j < all_cols_to_select.length; j++) {
						cols = cols.concat(all_cols_to_select[j][1])
					}
					for (var j = 0; j < cols.length; j++) {
						var col = cols[j];
						var option = document.createElement("option")
						option.value = col;
						option.innerText = displayCol(col, metadata, table_id, table_id);
						select.appendChild(option)
						// if it's supposed to be selected, select it
						if (col == display_subcol[i]["column"]) {
							select.selectedIndex = j;
						}
					}
					// set the last select to true/false depending on what it's supposed to be
					div.getElementsByTagName("select")[1].selectedIndex = display_subcol[i]["newline"] ? 0 : 1;
				}
			}
			// Called when we've just set variables fron the eval and need to update the screen to match
			var load = function load() {
				// first get tables
				getColumns(table_id, function() {
					// go advanced if we need to, seems broken right now
					if (all_joins != []) goAdvanced(); // <-- broken on this line, will always go advanced for some reason
					if (all_cols_to_select != []) goAdvanced();
					if (allowed_group_bys != null) goAdvanced();
					redrawDisplayCol(true);
					redrawDisplaySubcols(true);
					redrawGroupBys(true);
					// I've had all kinds of dirty asynchronous problems with this, redrawJoins needs to call getColumns which makes the rest of the function asynchronous, so we have
					// to block until it's done to redraw cols to select or redrawColsToSelect will change the global variables that redrawJoins depends on
					redrawJoins(true, function() {
						// Don't call update until this is done
						redrawColsToSelect(true, update);
					});
				});
			}
			// Returns the global variables as loadable javascript
			var save = function save() {
				update()
				var pre = document.getElementById("exported")
				var part = pre.innerText;
				part += "\n"
				part += "all_cols_to_select = " + print(all_cols_to_select) + ";"
				part += "\n"
				part += "all_joins = " + print(all_joins) + ";"
				return part
			}
			// Add a new display subcolumn element to the screen
			var add = function add(first) {
				var div = document.createElement("div")
				var idx = document.getElementById("subcols").children.length;
				div.id = "subcols-" + idx;

				var text = document.createElement("input")
				text.type = "text";
				text.setAttribute("data-subcol", idx);
				text.addEventListener("change", update);
				text.placeholder = "Text to display before the selected column, if any."

				// Options will be populated in redrawDisplaySubcols
				var select = document.createElement("select")
				select.addEventListener("change", update)
				select.setAttribute("data-subcol", idx);

				var select2 = document.createElement("select")
				select2.addEventListener("change", update)
				select2.setAttribute("data-subcol", idx);
				var option = document.createElement("option")
				option.value = true;
				option.innerText = "Break to next line";
				select2.appendChild(option)
				option = document.createElement("option")
				option.value = false;
				option.innerText = "Continue";
				select2.appendChild(option)

				var remove = document.createElement("button")
				remove.innerText = "-"
				remove.addEventListener("click", function() {
					alert("TODO");
				});

				div.appendChild(text);
				div.appendChild(select);
				div.appendChild(select2);
				div.appendChild(remove);
				document.getElementById("subcols").appendChild(div)

				// Add new display subcol to the array
				// Seems like this should be wrapped in an `if (!first)`
				display_subcol = display_subcol.concat({"display_name": "", "newline": true});
				if (!first) redrawDisplaySubcols(false);
			}
			// Adds the advanced options to the screen
			var goAdvanced = function() {
				if (advanced) return; // only run once
				// remove the button
				document.getElementById("goAdvanced").outerHTML = ""
				// Add the list of allowed group bys, empty list that will be populated in redrawGroupBys
				var allow_group_bys = document.createElement("input")
				allow_group_bys.type = "checkbox"
				allow_group_bys.id = "allow_group_bys"
				allow_group_bys.checked = true;
				allow_group_bys.addEventListener("change", update)
				document.getElementById("right").appendChild(allow_group_bys)
				document.getElementById("right").appendChild(document.createTextNode("Allow group bys"))
				var group_bys = document.createElement("div")
				group_bys.id = "group_bys"
				document.getElementById("right").appendChild(group_bys)
				// Populate list
				redrawGroupBys(true);

				// Add the add join button and the div that it needs
				var addjoin = document.createElement("button")
				addjoin.innerText = "Add join"
				addjoin.addEventListener("click", function() { newjoin(false); })
				var joins = document.createElement("div")
				joins.id = "joins"
				document.getElementById("right").appendChild(addjoin)
				document.getElementById("right").appendChild(joins)
				//redrawJoins(true);

				// Add the columns to select and draw (populate) it
				var cols_to_select = document.createElement("div");
				cols_to_select.id = "cols_to_select"
				document.getElementById("right").appendChild(cols_to_select);
				redrawColsToSelect(true);

				advanced = true;
			}
			// Adds a join option to the screen
			var newjoin = function newjoin(first) {
				// called in all the onchange listeners, update cols to select then update
				var handler = function() {
					redrawColsToSelect(false);
					update();
				}
				var joins = document.getElementById("joins")
				var idx = document.getElementById("joins").children.length
				var wrapper = document.createElement("div");
				wrapper.id = "join-" + idx;
				wrapper.innerText = "JOIN "
				// List of tables you can join on, populated in redrawJoins
				var select1 = document.createElement("select")
				select1.addEventListener("change", function() { redrawJoin(idx, false); handler(); });
				wrapper.appendChild(select1)
				wrapper.appendChild(document.createTextNode(" ON " + table_id + "."))
				// List of columns in this table, populated in redrawJoins
				var select2 = document.createElement("select")
				select2.addEventListener("change", handler);
				wrapper.appendChild(select2);
				wrapper.appendChild(document.createTextNode(" = "))
				var span = document.createElement("span")
				span.id = "join-" + idx + "-span"
				wrapper.appendChild(span)
				wrapper.appendChild(document.createTextNode("."))
				// List of columns in the join table, populated in redrawJoins
				var select3 = document.createElement("select")
				select3.addEventListener("change", handler);
				wrapper.appendChild(select3);
				// delete button
				var btn = document.createElement("button")
				btn.innerText = "-"
				btn.addEventListener("click", function() {
					alert("TODO")
				});
				wrapper.appendChild(btn);
				joins.appendChild(wrapper)
				if (!first) {
					all_joins = all_joins.concat(0);
					all_joins[idx] = [table_id, columns[table_id][0], columns[table_id][0]];
				}
				redrawJoin(idx, first);
			}
			// redraw a particular join clause on the screen, then execute the callback
			var redrawJoin = function redrawJoin(idx, first, cb) {
				if (!first) getJoins();
				var thing = document.getElementById("join-" + idx)
				// the list of tables you can join on
				var select1 = thing.getElementsByTagName("select")[0]
				select1.innerHTML = "";
				for (var i = 0; i < all_tables.length; i++) {
					var option = document.createElement("option")
					option.value = all_tables[i];
					option.innerText = display(localized_tables[all_tables[i]], all_tables[i], window.possible_wrapped.concat("title"), all_tables[i]);
					select1.appendChild(option);
					if (all_joins[idx][0] == all_tables[i]) {
						select1.selectedIndex = i;
					}
				}
				if (!first) getJoins();
				// the list of columns in this table
				var select2 = thing.getElementsByTagName("select")[1];
				select2.innerHTML = ""
				for (var i = 0; i < columns[table_id].length; i++) {
					var col = columns[table_id][i];
					var option = document.createElement("option")
					option.value = col;
					option.innerText = displayCol(col, metadata, table_id);
					select2.appendChild(option);
					if (all_joins[idx][1] == col) {
						select2.selectedIndex = i;
					}
				}

				// the list of all the columns in the other table
				var tbl = all_joins[idx][0];
				document.getElementById("join-" + idx + "-span").innerText = display(localized_tables[tbl], tbl, window.possible_wrapped.concat("title"), tbl);
				getColumns(tbl, function() {
					var select = thing.getElementsByTagName("select")[2];
					select.innerHTML = "";
					var cols = ["_id"].concat(columns[tbl])
					for (var i = 0; i < cols.length; i++) {
						var col = cols[i];
						var option = document.createElement("option")
						option.value = col;
						option.innerText = displayCol(col, metadata, tbl);
						select.appendChild(option);
						if (all_joins[idx][2] == col) {
							select.selectedIndex = i;
						}
					}
					if (typeof(cb) != "undefined") cb()
				});
			}
			// pulls the joins off the screen and into the two global variables
			var getJoins = function getJoins() {
				if (!advanced) {
					all_joins = []
					return;
				}
				all_joins = []
				var thing = document.getElementById("joins")
				for (var i = 0; i < thing.children.length; i++) {
					var join = document.getElementById("join-" + i);
					all_joins = all_joins.concat(0);
					var selects = join.getElementsByTagName("select");
					all_joins[i] = [
						selects[0].selectedOptions[0] == null ? table_id : selects[0].selectedOptions[0].value,
						selects[1].selectedOptions[0] == null ? "" : selects[1].selectedOptions[0].value,
						selects[2].selectedOptions[0] == null ? "" : selects[2].selectedOptions[0].value
					]
				}
				global_join = []
				for (var i = 0; i < all_joins.length; i++) {
					global_join = global_join.concat(all_joins[i][0] + " ON " + table_id + "." + all_joins[i][1] + " = " + all_joins[i][0] + "." + all_joins[i][2])
				}
				global_join = global_join.join(" JOIN ")
			}
			// redraws all joins then executs the callback
			var redrawJoins = function redrawJoins(first, cb) {
				if (!first) getJoins();
				var len = document.getElementById("joins").children.length;
				for (var i = 0; i < all_joins.length - len; i++) {
					newjoin(first);
					len++;
				}
				var running = len;
				for (var i = 0; i < len; i++) {
					redrawJoin(i, first, function() { running--; });
				}
				var post = function post() {
					if (running > 0) {
						setTimeout(post, 50);
						return;
					}
					cb();
				}
				if (typeof(cb) != "undefined") post();
			}
			// pulls the group bys off the screen and into the allowed_group_bys argument
			var getGroupBys = function getGroupBys() {
				if (!advanced) return;
				if (!document.getElementById("allow_group_bys").checked) {
					allowed_group_bys = [];
					return allow_group_bys;
				}
				allowed_group_bys = []
				var elems = document.getElementsByClassName("group_by")
				for (var i = 0; i < elems.length; i++) {
					var elem = elems[i];
					if (elem.checked) {
						var col = elem.getAttribute("data-dbcol")
						var display_input = document.getElementById(col + "-display")
						if (display_input.tagName == "SELECT") {
							var value = display_input.selectedOptions[0].value
							if (value == "custom") {
								display_input.outerHTML = "<input type='text' id='"+col+"-display' />"
								document.getElementById(col + "-display").value = displayCol(col, metadata, table_id, table_id)
								document.getElementById(col + "-display").addEventListener("change", update)
								display_input = true;
							} else {
								display_input = value == "true" ? true : false;
							}
						} else {
							display_input = display_input.value;
						}
						var item = {"column": col};
						if (typeof(display_input) == "string") {
							item["display_name"] = display_input;
						} else {
							item["pretty"] = display_input;
						}
						allowed_group_bys = allowed_group_bys.concat(item);
					}
				}
			}
			// Populates the allowed group bys on the screen, sets checked on the boxes if necessary, etc..
			var redrawGroupBys = function redrawGroupBys(first) {
				if (!first) getColsToSelect();
				var group_bys = document.getElementById("group_bys");
				group_bys.innerHTML = ""
				var cols = columns[table_id]
				for (var j = 0; j < all_cols_to_select.length; j++) {
					cols = cols.concat(all_cols_to_select[j][1])
				}
				for (var i = 0; i < cols.length; i++) {
					var col = cols[i];
					var box = document.createElement("input")
					box.type = "checkbox"
					box.setAttribute("data-dbcol", col);
					box.classList.add("group_by")
					box.id = col;
					box.name = col;
					box.addEventListener("change", update)
					var exists = false;
					var value = true
					if (allowed_group_bys == null) {
						exists = true;
					} else {
						for (var j = 0; j < allowed_group_bys.length; j++) {
							if (allowed_group_bys[j]["column"] == col) {
								exists = true;
								if ("pretty" in allowed_group_bys[j]) {
									value = allowed_group_bys[j]["pretty"];
								} else {
									value = allowed_group_bys[j]["display_name"]
								}
								break;
							}
						}
					}
					if (exists) {
						box.checked = true;
					}
					var select;
					if (value === true || value === false) {
						select = document.createElement("select");
						var option = document.createElement("option")
						option.value = "true";
						option.innerText = "Pretty"
						select.appendChild(option)
						option = document.createElement("option")
						option.value = "false";
						option.innerText = "Raw"
						select.appendChild(option)
						option = document.createElement("option")
						option.value = "custom";
						option.innerText = "Custom"
						select.appendChild(option)
						select.selectedIndex = value == true ? 0 : 1;
					} else {
						select = document.createElement("input")
						select.type = "text"
						select.value = value;
					}
					select.id = col + "-display"
					select.addEventListener("change", update);
					var label = document.createElement("label")
					label.setAttribute("for", col);
					label.innerText = displayCol(col, metadata, table_id, table_id);
					var wrapper = document.createElement("div")
					wrapper.appendChild(box)
					wrapper.appendChild(select)
					wrapper.appendChild(label)
					group_bys.appendChild(wrapper)
				}
			}
			// pulls the columns to select off the screen and into its two global variables
			var getColsToSelect = function getColsToSelect() {
				if (!advanced) {
					global_which_cols_to_select = table_id + ".*"
					all_cols_to_select = [];
					return;
				}
				var elems = document.getElementById("cols_to_select").getElementsByTagName("input")
				all_cols_to_select = [];
				for (var i = 0; i < elems.length; i += 2) {
					if (!elems[i].checked) continue;
					all_cols_to_select = all_cols_to_select.concat(0);
					all_cols_to_select[all_cols_to_select.length - 1] = [elems[i].getAttribute("data-dbcol"), elems[i + 1].value]
				}
				global_which_cols_to_select = table_id + ".*"
				for (var i = 0; i < all_cols_to_select.length; i++) {
					global_which_cols_to_select += ", " + all_cols_to_select[i][0] + " AS " + all_cols_to_select[i][1]
				}
			}
			// redraws the columns that can be selected from the join tables
			var redrawColsToSelect = function redrawColsToSelect(first, cb) {
				if (!first) getColsToSelect()
				var handler = function handler() {
					// TODO redraw display col too, the display col is allowed to be from the joined table
					redrawDisplaySubcols(first);
					redrawGroupBys(first);
					update();
				}
				var div = document.getElementById("cols_to_select")
				div.innerHtml = ""
				div.innerText = table_id + ".*, "
				if (!first) getJoins()
				var running = all_joins.length;
				// allow grouping by all columns in all the tables you've joined as well
				for (var i = 0; i < all_joins.length; i++) {
					var tbl = all_joins[i][0];
					getColumns(tbl, function() {
						for (var j = 0; j < columns[tbl].length; j++) {
							var col = columns[tbl][j];
							var wrapper = document.createElement("div")
							var box = document.createElement("input")
							box.addEventListener("change", handler);
							box.type = "checkbox"
							box.id = "select-" + tbl + "-" + col;
							box.setAttribute("data-dbcol", tbl + "." + col)
							var found = false;
							var value = ""
							for (var k = 0; k < all_cols_to_select.length; k++) {
								//alert("Checking that " + all_cols_to_select[k][0] + " matches " + tbl + "." + col);
								if (all_cols_to_select[k][0] == tbl + "." + col) {
									found = true;
									value = all_cols_to_select[k][1];
									break;
								}
							}
							box.checked = found;
							wrapper.appendChild(box)
							wrapper.appendChild(document.createTextNode(tbl + "." + displayCol(col, metadata, tbl, tbl) + " AS "))
							var input = document.createElement("input")
							input.addEventListener("change", handler);
							input.id = "select-" + tbl + "-" + col + "-as";
							input.value = value;
							wrapper.appendChild(input);
							div.appendChild(wrapper);
						}
						running--;
					})
				}
				if (typeof(cb) != "undefined") {
					var post = function post() {
						if (running > 0) {
							setTimeout(post, 50);
							return;
						}
						cb();
					}
					post();
				}
			}
			// Redraws the display column from the variable, populates the list with all columns in this table and the columns being pulled from other tables
			var redrawDisplayCol = function redrawDisplayCol(first) {
				if (!first) getDisplayCol();
				console.log("DISPLAY COL IS " + display_col)
				var cols = columns[table_id];
				for (var i = 0; i < all_cols_to_select.length; i++) {
					cols = cols.concat(all_cols_to_select[i][1]);
				}
				document.getElementById("display_col").innerHTML = ""
				for (var i = 0; i < cols.length; i++) {
					var option = document.createElement("option")
					option.value = cols[i];
					option.innerText = displayCol(cols[i], metadata, table_id, table_id);
					document.getElementById("display_col").appendChild(option)
					console.log("Checking " + cols[i] + " against " + display_col)
					if (cols[i] == display_col) {
						document.getElementById("display_col").selectedIndex = i;
					}
				}
			}
			var print = function print(thing) {
				//return JSON.stringify(thing, null, "\t")
				return JSON.stringify(thing)
			}
			var userSave = function() {
				//prompt("Copy this configuration to somewhere safe, then paste it into the Custom Js On Load section of a List View in the Files tab to use it.", save())
				var filename = prompt("Please enter the filename of the new file")
				if (filename.trim() == "") {
					alert("Filename cannot be empty");
					return;
				}
				var request = new XMLHttpRequest();
				request.onreadystatechange = function() {
					if (request.readyState == XMLHttpRequest.DONE && request.status == 200) {
						var files = JSON.parse(request.responseText)
						for (var j = 0; j < files.length; j++) {
							if (files[j][0] == filename) {
								alert("That file already exists!");
								return;
							}
						}
						files = files.concat(0)
						files[files.length - 1] = [filename, "table", "", "", save(), "", ""]
						postFile(USER_CONFIG_LOCATION, JSON.stringify(files));
					}
				}
				request.open("GET", USER_CONFIG_LOCATION, true);
				request.send()

			}
			var userLoad = function() {
				("global",eval)(prompt("Paste in your saved configuration here. Please make sure you've chosen the right table first!"))
				load();
			}

		</script>
		<style>
			#iframe {
				width: 70%;
				top: 0%;
				bottom: 0%;
				display: block;
				position: absolute;
				left: 0%;
				background-color: white;
			}
			#right {
				position: absolute;
				left: 70%;
				padding-left: 8px;
				width: 29%;
				top: 8px;
			}
			body {
				min-height: 100%;
			}
			select {
				min-width: 100px;
			}
			label {
				padding-left: 8px;
			}
		</style>
	</head>
	<body onLoad='ol();'>
		<iframe id='iframe'></iframe>
		<div id='right'>
			<button onClick='userSave();' id='save'>Save</button><br />
			<button onClick='userLoad();' id='load'>Load</button><br />
			<button onClick='goAdvanced();' id='goAdvanced'>Go Advanced</button><br />
			Table: 
			<select id='table_id' onChange='newTable();'></select>
			<br />
			Display Column: 
			<select id='display_col' onChange='update();'></select>
			<br />
			<button id='add' onClick='add(false);'>+</button>
			<div id='subcols'></div>
			<pre style="display: none" id='exported'></pre>
		</div>
	</body>
</html>
